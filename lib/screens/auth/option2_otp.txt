import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import '../../constants/colors.dart';
import '../../constants/text_styles.dart';
import '../../constants/app_dimensions.dart';
import '../../services/auth_service.dart';
import '../main/main_navigation_screen.dart';

class OTPScreen extends StatefulWidget {
  final String phoneNumber;
  final String countryCode;

  const OTPScreen({
    super.key,
    required this.phoneNumber,
    this.countryCode = '+234',
  });

  @override
  State<OTPScreen> createState() => _OTPScreenState();
}

class _OTPScreenState extends State<OTPScreen>
    with SingleTickerProviderStateMixin {
  final List<TextEditingController> _controllers =
      List.generate(6, (_) => TextEditingController());
  final List<FocusNode> _focusNodes = List.generate(6, (_) => FocusNode());
  final AuthService _authService = AuthService();

  late AnimationController _fadeController;
  late Animation<double> _fadeAnimation;

  bool _isVerifying = false;
  bool _canResend = false;
  int _resendTimer = 60;
  Timer? _timer;
  int _attemptCount = 0;
  static const int _maxAttempts = 5;

  @override
  void initState() {
    super.initState();
    _setupAnimations();
    _startResendTimer();
    
    // Auto-focus first field
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _focusNodes[0].requestFocus();
    });

    // Add listeners to focus nodes for visual feedback
    for (var i = 0; i < _focusNodes.length; i++) {
      _focusNodes[i].addListener(() {
        setState(() {}); // Rebuild to show focus state
      });
    }
  }

  void _setupAnimations() {
    _fadeController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 600),
    );
    _fadeAnimation = CurvedAnimation(
      parent: _fadeController,
      curve: Curves.easeIn,
    );
    _fadeController.forward();
  }

  @override
  void dispose() {
    _timer?.cancel();
    for (var controller in _controllers) {
      controller.dispose();
    }
    for (var node in _focusNodes) {
      node.dispose();
    }
    _fadeController.dispose();
    super.dispose();
  }

  void _startResendTimer() {
    setState(() {
      _canResend = false;
      _resendTimer = 60;
    });

    _timer?.cancel();
    _timer = Timer.periodic(const Duration(seconds: 1), (timer) {
      if (!mounted) {
        timer.cancel();
        return;
      }

      setState(() {
        if (_resendTimer > 0) {
          _resendTimer--;
        } else {
          _canResend = true;
          timer.cancel();
        }
      });
    });
  }

  void _onCodeChanged(String value, int index) {
    if (value.isEmpty) return;

    // Auto-advance to next field
    if (index < 5) {
      _focusNodes[index + 1].requestFocus();
    } else {
      // Last field filled, unfocus and verify
      FocusScope.of(context).unfocus();
    }

    // Check if all fields are filled
    final allFilled = _controllers.every((c) => c.text.isNotEmpty);
    if (allFilled) {
      // Small delay for better UX
      Future.delayed(const Duration(milliseconds: 300), () {
        if (mounted) _verifyOTP();
      });
    }
  }

  void _onBackspacePressed(int index) {
    if (_controllers[index].text.isEmpty && index > 0) {
      _focusNodes[index - 1].requestFocus();
      _controllers[index - 1].clear();
    }
  }

  Future<void> _verifyOTP() async {
    final otp = _controllers.map((c) => c.text).join();
    
    if (otp.length != 6) {
      _showError('Please enter the complete 6-digit code');
      return;
    }

    // Check attempt limit
    if (_attemptCount >= _maxAttempts) {
      _showError(
        'Maximum attempts exceeded. Please request a new code.',
      );
      _clearOTP();
      return;
    }

    setState(() {
      _isVerifying = true;
      _attemptCount++;
    });

    try {
      final response = await _authService.verifyOtp(widget.phoneNumber, otp);

      if (!mounted) return;

      setState(() => _isVerifying = false);

      if (response.isSuccess) {
        _showSuccess('Welcome to SwiftRide!');
        
        // Navigate to main screen with smooth transition
        await Future.delayed(const Duration(milliseconds: 500));
        
        if (!mounted) return;
        
        Navigator.pushAndRemoveUntil(
          context,
          PageRouteBuilder(
            pageBuilder: (context, animation, secondaryAnimation) {
              return const MainNavigationScreen();
            },
            transitionsBuilder: (context, animation, secondaryAnimation, child) {
              const begin = Offset(1.0, 0.0);
              const end = Offset.zero;
              const curve = Curves.easeInOut;
              
              var tween = Tween(begin: begin, end: end).chain(
                CurveTween(curve: curve),
              );
              
              return SlideTransition(
                position: animation.drive(tween),
                child: child,
              );
            },
            transitionDuration: const Duration(milliseconds: 400),
          ),
          (_) => false,
        );
      } else {
        _showError(response.error ?? 'Invalid code. Please try again.');
        _clearOTP();
        
        // Show remaining attempts
        final remainingAttempts = _maxAttempts - _attemptCount;
        if (remainingAttempts > 0 && remainingAttempts <= 2) {
          Future.delayed(const Duration(milliseconds: 1500), () {
            if (!mounted) return;
            _showWarning('$remainingAttempts attempts remaining');
          });
        }
      }
    } catch (e) {
      if (!mounted) return;
      setState(() => _isVerifying = false);
      _showError('Network error. Please check your connection.');
      debugPrint('OTP verification error: $e');
    }
  }

  Future<void> _resendOTP() async {
    if (!_canResend) return;

    try {
      final response = await _authService.sendOtp(widget.phoneNumber);

      if (!mounted) return;

      if (response.isSuccess) {
        _showSuccess(
          response.data?['message'] ?? 'New code sent successfully',
        );
        _startResendTimer();
        _attemptCount = 0; // Reset attempts on new code
        _clearOTP();
      } else {
        _showError(response.error ?? 'Failed to resend code');
      }
    } catch (e) {
      if (!mounted) return;
      _showError('Network error. Please check your connection.');
      debugPrint('Resend OTP error: $e');
    }
  }

  void _clearOTP() {
    for (var controller in _controllers) {
      controller.clear();
    }
    _focusNodes[0].requestFocus();
  }

  void _showError(String message) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            const Icon(Icons.error_outline, color: Colors.white),
            const SizedBox(width: 12),
            Expanded(child: Text(message)),
          ],
        ),
        backgroundColor: AppColors.error,
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(AppDimensions.radiusMedium),
        ),
        duration: const Duration(seconds: 4),
      ),
    );
  }

  void _showSuccess(String message) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            const Icon(Icons.check_circle_outline, color: Colors.white),
            const SizedBox(width: 12),
            Expanded(child: Text(message)),
          ],
        ),
        backgroundColor: AppColors.success,
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(AppDimensions.radiusMedium),
        ),
      ),
    );
  }

  void _showWarning(String message) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            const Icon(Icons.warning_amber_rounded, color: Colors.white),
            const SizedBox(width: 12),
            Expanded(child: Text(message)),
          ],
        ),
        backgroundColor: AppColors.warning,
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(AppDimensions.radiusMedium),
        ),
      ),
    );
  }

 String get _maskedPhoneNumber {
  final phone = widget.phoneNumber.trim();
  if (phone.isEmpty) return 'Unknown number';

  // Extract country code
  String displayCode = widget.countryCode;
  String numberPart = phone;

  // If the number starts with '+', separate the country code and number
  if (phone.startsWith('+')) {
    final match = RegExp(r'^\+(\d{1,4})(.*)$').firstMatch(phone);
    if (match != null) {
      displayCode = '+${match.group(1)!}';
      numberPart = match.group(2)!.trim();
    }
  }

  // Safely get the last four digits (or all digits if shorter)
  final lastFour = numberPart.length >= 4
      ? numberPart.substring(numberPart.length - 4)
      : numberPart;

  // Return formatted masked string
  return '$displayCode ••• $lastFour';
}


  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;
    final bottomInset = MediaQuery.of(context).viewInsets.bottom;

    return Scaffold(
      backgroundColor: AppColors.backgroundPrimary,
      resizeToAvoidBottomInset: true,
      body: FadeTransition(
        opacity: _fadeAnimation,
        child: SafeArea(
          child: SingleChildScrollView(
            padding: EdgeInsets.only(
              left: AppDimensions.paddingXXLarge,
              right: AppDimensions.paddingXXLarge,
              top: AppDimensions.paddingLarge,
              bottom: bottomInset + AppDimensions.paddingXXLarge,
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.center,
              children: [
                // Back button
                Align(
                  alignment: Alignment.centerLeft,
                  child: IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(
                      Icons.arrow_back,
                      color: AppColors.textPrimary,
                    ),
                    style: IconButton.styleFrom(
                      backgroundColor: AppColors.surface,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(
                          AppDimensions.radiusMedium,
                        ),
                      ),
                    ),
                  ),
                ),

                SizedBox(height: size.height * 0.06),

                // Icon with gradient background
                Container(
                  width: 80,
                  height: 80,
                  decoration: BoxDecoration(
                    gradient: AppColors.primaryGradient,
                    shape: BoxShape.circle,
                    boxShadow: [
                      BoxShadow(
                        color: AppColors.primary.withOpacity(0.3),
                        blurRadius: 20,
                        spreadRadius: 3,
                      ),
                    ],
                  ),
                  child: const Icon(
                    Icons.lock_outline_rounded,
                    color: Colors.white,
                    size: 36,
                  ),
                ),

                const SizedBox(height: 24),

                // Title
                Text(
                  'Verification Code',
                  style: AppTextStyles.heading1.copyWith(fontSize: 28),
                ),

                const SizedBox(height: 12),

                // Subtitle
                Text.rich(
                  TextSpan(
                    text: 'Enter the 6-digit code sent to\n',
                    style: AppTextStyles.bodyMedium,
                    children: [
                      TextSpan(
                        text: _maskedPhoneNumber,
                        style: AppTextStyles.bodyMedium.copyWith(
                          color: AppColors.primary,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                  textAlign: TextAlign.center,
                ),

                const SizedBox(height: 48),

                // OTP Input Boxes
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                  children: List.generate(6, (index) {
                    final hasFocus = _focusNodes[index].hasFocus;
                    final hasValue = _controllers[index].text.isNotEmpty;

                    return _OTPBox(
                      controller: _controllers[index],
                      focusNode: _focusNodes[index],
                      hasFocus: hasFocus,
                      hasValue: hasValue,
                      onChanged: (value) => _onCodeChanged(value, index),
                      onBackspace: () => _onBackspacePressed(index),
                    );
                  }),
                ),

                const SizedBox(height: 48),

                // Loading or verify status
                if (_isVerifying)
                  const Column(
                    children: [
                      SizedBox(
                        width: 32,
                        height: 32,
                        child: CircularProgressIndicator(
                          strokeWidth: 3,
                          valueColor: AlwaysStoppedAnimation<Color>(
                            AppColors.primary,
                          ),
                        ),
                      ),
                      SizedBox(height: 16),
                      Text(
                        'Verifying code...',
                        style: AppTextStyles.bodyMedium,
                      ),
                    ],
                  )
                else
                  Column(
                    children: [
                      // Resend button/timer
                      if (_canResend)
                        TextButton.icon(
                          onPressed: _resendOTP,
                          icon: const Icon(
                            Icons.refresh_rounded,
                            size: 20,
                          ),
                          label: const Text('Resend Code'),
                          style: TextButton.styleFrom(
                            foregroundColor: AppColors.primary,
                            textStyle: AppTextStyles.button,
                          ),
                        )
                      else
                        Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            const Text(
                              'Resend code in ',
                              style: AppTextStyles.bodyMedium,
                            ),
                            Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 12,
                                vertical: 4,
                              ),
                              decoration: BoxDecoration(
                                color: AppColors.surface,
                                borderRadius: BorderRadius.circular(
                                  AppDimensions.radiusSmall,
                                ),
                              ),
                              child: Text(
                                '${_resendTimer}s',
                                style: AppTextStyles.bodyMedium.copyWith(
                                  color: AppColors.primary,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ),
                          ],
                        ),

                      const SizedBox(height: 16),

                      // Attempt counter (only show when attempts are made)
                      if (_attemptCount > 0)
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 16,
                            vertical: 8,
                          ),
                          decoration: BoxDecoration(
                            color: _attemptCount >= 3
                                ? AppColors.error.withOpacity(0.1)
                                : AppColors.surface,
                            borderRadius: BorderRadius.circular(
                              AppDimensions.radiusSmall,
                            ),
                            border: Border.all(
                              color: _attemptCount >= 3
                                  ? AppColors.error.withOpacity(0.3)
                                  : AppColors.border,
                            ),
                          ),
                          child: Text(
                            'Attempts: $_attemptCount/$_maxAttempts',
                            style: AppTextStyles.caption.copyWith(
                              color: _attemptCount >= 3
                                  ? AppColors.error
                                  : AppColors.textSecondary,
                            ),
                          ),
                        ),
                    ],
                  ),

                const SizedBox(height: 32),

                // Help text
                TextButton(
                  onPressed: () {
                    // Navigate to support or show help dialog
                  },
                  child: Text(
                    'Didn\'t receive the code?',
                    style: AppTextStyles.bodyMedium.copyWith(
                      color: AppColors.textSecondary,
                      decoration: TextDecoration.underline,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

// Custom OTP Box Widget
class _OTPBox extends StatelessWidget {
  final TextEditingController controller;
  final FocusNode focusNode;
  final bool hasFocus;
  final bool hasValue;
  final ValueChanged<String> onChanged;
  final VoidCallback onBackspace;

  const _OTPBox({
    required this.controller,
    required this.focusNode,
    required this.hasFocus,
    required this.hasValue,
    required this.onChanged,
    required this.onBackspace,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      width: 50,
      height: 60,
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(AppDimensions.radiusMedium),
        border: Border.all(
          color: hasFocus
              ? AppColors.primary
              : hasValue
                  ? AppColors.primary.withOpacity(0.4)
                  : AppColors.border,
          width: hasFocus ? 2 : 1.5,
        ),
        boxShadow: hasFocus
            ? [
                BoxShadow(
                  color: AppColors.primary.withOpacity(0.2),
                  blurRadius: 8,
                  spreadRadius: 2,
                ),
              ]
            : null,
      ),
      child: KeyboardListener(
        focusNode: FocusNode(),
        onKeyEvent: (event) {
          if (event is KeyDownEvent &&
              event.logicalKey == LogicalKeyboardKey.backspace) {
            if (controller.text.isEmpty) {
              onBackspace();
            }
          }
        },
        child: TextField(
          controller: controller,
          focusNode: focusNode,
          textAlign: TextAlign.center,
          style: AppTextStyles.heading2.copyWith(
            color: AppColors.primary,
            fontWeight: FontWeight.bold,
          ),
          keyboardType: TextInputType.number,
          maxLength: 1,
          decoration: const InputDecoration(
            border: InputBorder.none,
            counterText: '',
            contentPadding: EdgeInsets.zero,
          ),
          inputFormatters: [
            FilteringTextInputFormatter.digitsOnly,
          ],
          onChanged: onChanged,
        ),
      ),
    );
  }
}












































































// ==================== otp_screen.dart (refined production version) ====================
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:swiftride/screens/main/main_navigation_screen.dart';
import '../../services/auth_service.dart';

class OTPScreen extends StatefulWidget {
  final String phoneNumber;

  const OTPScreen({
    super.key,
    required this.phoneNumber,
  });

  @override
  State<OTPScreen> createState() => _OTPScreenState();
}

class _OTPScreenState extends State<OTPScreen>
    with SingleTickerProviderStateMixin {
  final List<TextEditingController> _controllers =
      List.generate(6, (index) => TextEditingController());
  final List<FocusNode> _focusNodes = List.generate(6, (index) => FocusNode());
  final AuthService _authService = AuthService();

  bool _isVerifying = false;
  bool _canResend = false;
  int _resendTimer = 60;
  Timer? _timer;
  late AnimationController _fadeController;

  @override
  void initState() {
    super.initState();
    _fadeController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 900),
    )..forward();
    _startResendTimer();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _focusNodes[0].requestFocus();
    });
  }

  @override
  void dispose() {
    _timer?.cancel();
    for (var c in _controllers) c.dispose();
    for (var f in _focusNodes) f.dispose();
    _fadeController.dispose();
    super.dispose();
  }

  void _startResendTimer() {
    setState(() {
      _canResend = false;
      _resendTimer = 60;
    });
    _timer?.cancel();
    _timer = Timer.periodic(const Duration(seconds: 1), (timer) {
      if (_resendTimer <= 0) {
        timer.cancel();
        if (mounted) setState(() => _canResend = true);
      } else {
        if (mounted) setState(() => _resendTimer--);
      }
    });
  }

  void _onCodeChanged(String value, int index) {
    if (value.isNotEmpty && index < 5) {
      _focusNodes[index + 1].requestFocus();
    }
  }

  Future<void> _verifyOTP() async {
    String otp = _controllers.map((c) => c.text).join();
    if (otp.length != 6) {
      _showError('Please enter complete OTP');
      return;
    }
    setState(() => _isVerifying = true);
    try {
      final res = await _authService.verifyOtp(widget.phoneNumber, otp);
      setState(() => _isVerifying = false);
      if (res.isSuccess) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Welcome to SwiftRide!'),
            backgroundColor: Colors.green,
          ),
        );
        Navigator.pushAndRemoveUntil(
          context,
          MaterialPageRoute(builder: (_) => const MainNavigationScreen()),
          (_) => false,
        );
      } else {
        _showError(res.error ?? 'Invalid OTP');
        for (var c in _controllers) c.clear();
        _focusNodes[0].requestFocus();
      }
    } catch (_) {
      setState(() => _isVerifying = false);
      _showError('Network error. Please try again.');
    }
  }

  Future<void> _resendOTP() async {
    if (!_canResend) return;
    _startResendTimer();
    try {
      final res = await _authService.sendOtp(widget.phoneNumber);
      if (res.isSuccess) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(res.data?['message'] ?? 'New OTP sent successfully'),
            backgroundColor: Colors.green,
          ),
        );
      } else {
        _showError(res.error ?? 'Failed to resend OTP');
      }
    } catch (_) {
      _showError('Network error. Please try again.');
    }
  }

  void _showError(String msg) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(msg), backgroundColor: Colors.red),
    );
  }

  @override
  Widget build(BuildContext context) {
    final primaryColor = const Color(0xFF0066FF);
    final backgroundColor = const Color(0xFF0A0A0A);
    final maskedPhone = widget.phoneNumber.replaceRange(
      0,
      widget.phoneNumber.length - 4,
      '••••••',
    );

    return Scaffold(
      backgroundColor: backgroundColor,
      resizeToAvoidBottomInset: true,
      body: FadeTransition(
        opacity: _fadeController,
        child: SafeArea(
          child: SingleChildScrollView(
            padding: EdgeInsets.only(
              left: 24,
              right: 24,
              top: 20,
              bottom: MediaQuery.of(context).viewInsets.bottom + 20,
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.center,
              mainAxisSize: MainAxisSize.min,
              children: [
                Align(
                  alignment: Alignment.centerLeft,
                  child: IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.arrow_back, color: Colors.white),
                  ),
                ),
                const SizedBox(height: 20),

                // App Icon
                Container(
                  width: 80,
                  height: 80,
                  decoration: BoxDecoration(
                    gradient: const LinearGradient(
                      colors: [Color(0xFF0066FF), Color(0xFF00D9FF)],
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                    ),
                    shape: BoxShape.circle,
                    boxShadow: [
                      BoxShadow(
                        color: primaryColor.withOpacity(0.4),
                        blurRadius: 20,
                        spreadRadius: 2,
                      ),
                    ],
                  ),
                  child: const Icon(
                    Icons.directions_car_rounded,
                    color: Colors.white,
                    size: 40,
                  ),
                ),
                const SizedBox(height: 16),

                const Text(
                  "SwiftRide",
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 28,
                    fontWeight: FontWeight.bold,
                    letterSpacing: -1.0,
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  "Enter the 6-digit code sent to\n$maskedPhone",
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.8),
                    fontSize: 14,
                  ),
                ),
                const SizedBox(height: 32),

                // OTP Boxes
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                  children: List.generate(6, (index) {
                    return AnimatedContainer(
                      duration: const Duration(milliseconds: 250),
                      width: 45,
                      height: 55,
                      decoration: BoxDecoration(
                        color: const Color(0xFF1A1A1A),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(
                          color: _focusNodes[index].hasFocus
                              ? primaryColor
                              : Colors.grey[600]!,
                          width: _focusNodes[index].hasFocus ? 2 : 1,
                        ),
                        boxShadow: _focusNodes[index].hasFocus
                            ? [
                                BoxShadow(
                                  color: primaryColor.withOpacity(0.3),
                                  blurRadius: 8,
                                  spreadRadius: 1,
                                ),
                              ]
                            : [],
                      ),
                      child: TextField(
                        controller: _controllers[index],
                        focusNode: _focusNodes[index],
                        textAlign: TextAlign.center,
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                          letterSpacing: 1,
                        ),
                        keyboardType: TextInputType.number,
                        maxLength: 1,
                        decoration: const InputDecoration(
                          border: InputBorder.none,
                          counterText: '',
                        ),
                        inputFormatters: [
                          FilteringTextInputFormatter.digitsOnly,
                        ],
                        onChanged: (val) => _onCodeChanged(val, index),
                      ),
                    );
                  }),
                ),

                const SizedBox(height: 40),

                // Verify Button
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: _isVerifying ? null : _verifyOTP,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: primaryColor,
                      padding: const EdgeInsets.symmetric(vertical: 14),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    child: _isVerifying
                        ? const SizedBox(
                            height: 24,
                            width: 24,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              color: Colors.white,
                            ),
                          )
                        : const Text(
                            "Verify",
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                  ),
                ),

                const SizedBox(height: 30),

                AnimatedOpacity(
                  duration: const Duration(milliseconds: 500),
                  opacity: _canResend ? 1.0 : 0.6,
                  child: _canResend
                      ? TextButton(
                          onPressed: _resendOTP,
                          child: Text(
                            "Resend code",
                            style: TextStyle(
                              color: primaryColor,
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        )
                      : Text(
                          "Resend code in $_resendTimer s",
                          style: TextStyle(
                            color: Colors.white.withOpacity(0.6),
                            fontSize: 14,
                          ),
                        ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
